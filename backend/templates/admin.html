<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Soporte</title>
    <style>
        body { margin: 0; font-family: sans-serif; }
        nav { background: #ffa500; padding: 10px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .nav-buttons { display: flex; gap: 10px; }
        nav button { background: transparent; border: none; color: white; font-size: 16px; cursor: pointer; }
        nav button.active { font-weight: bold; text-decoration: underline; }
        nav a { color: white; text-decoration: none; font-size: 14px; }

        #container { display: flex; height: calc(100vh - 48px); }
        #clientes { width: 200px; background: #f0f0f0; padding: 10px; overflow-y: auto; border-right: 1px solid #ddd; }
        .cliente { cursor: pointer; padding: 8px; margin-bottom: 5px; background: #fff; border-radius: 4px; border: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .cliente.selected { background-color: #ffa500; color: white; border-color: #e69500; }
        .cliente button { background: #fff; border: 1px solid #aaa; border-radius: 3px; padding: 2px 5px; font-size: 12px; cursor: pointer; }
        .cliente.selected button { background: white; color: #ffa500; }

        #seccion-chats, #seccion-tickets { flex: 1; display: none; padding: 10px; box-sizing: border-box; }
        #seccion-chats.active, #seccion-tickets.active { display: block; }

        /* Chat view */
        #chat { display: flex; flex-direction: column; height: 100%; }
        #chat-mensajes { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding: 10px; background: #fafafa; border: 1px solid #ddd; border-radius: 4px; }
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 12px; line-height: 1.4; }
        .msg.msg-cliente { background: #fff; align-self: flex-start; border: 1px solid #ddd; }
        .msg.msg-agente { background: #ffa500; color: white; align-self: flex-end; }
        #chat-input { display: flex; gap: 10px; margin-top: 10px; }
        #chat-input input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #chat-input button { padding: 8px 12px; background: #ffa500; border: none; color: white; border-radius: 4px; cursor: pointer; }

        /* Tickets view */
        .ticket { background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 8px; }
        .ticket button { margin-top: 5px; padding: 4px 8px; background: #28a745; border: none; color: white; border-radius: 3px; cursor: pointer; }
        .ticket button[disabled] { background: #6c757d; cursor: default; }
    </style>
</head>
<body>
    <nav>
        <div class="nav-buttons">
            <button id="btn-chats" class="active" onclick="mostrarSeccion('chats')">Chats</button>
            <button id="btn-tickets" onclick="mostrarSeccion('tickets')">Tickets</button>
        </div>
        <div>
            Agente: <strong>{{ agente }}</strong> |
            <a href="{{ url_for('logout') }}">Cerrar sesi√≥n</a>
        </div>
    </nav>
    <div id="container">
        <div id="clientes"></div>
        <div id="seccion-chats" class="active">
            <div id="chat">
                <div id="chat-mensajes"></div>
                <div id="chat-input">
                    <input type="text" id="respuesta" placeholder="Escribe tu respuesta...">
                    <button onclick="responder()">Enviar</button>
                </div>
            </div>
        </div>
        <div id="seccion-tickets">
            <h2>Tickets fuera de horario</h2>
            <div id="lista-tickets"></div>
        </div>
    </div>
    <script>
        const agenteNombre = "{{ agente }}";
        let clienteSeleccionado = null;
        let asignaciones = {};
        
        function mostrarSeccion(sec) {
            document.getElementById('btn-chats').classList.toggle('active', sec==='chats');
            document.getElementById('btn-tickets').classList.toggle('active', sec==='tickets');
            document.getElementById('seccion-chats').classList.toggle('active', sec==='chats');
            document.getElementById('seccion-tickets').classList.toggle('active', sec==='tickets');
            if (sec==='tickets') cargarTickets();
        }
        
        function cargarAsignaciones() {
            fetch('/conversaciones')
                .then(res=>res.json())
                .then(data=>{
                    asignaciones = {};
                    data.forEach(c=> asignaciones[c.cliente_id] = c.agente_nombre);
                    renderClientes();
                });
        }
        
        function renderClientes() {
            const cont = document.getElementById('clientes');
            cont.innerHTML = '';
            fetch('/clientes')
                .then(res=>res.json())
                .then(data=>data.forEach(cliente=>{
                    const div=document.createElement('div');
                    div.className='cliente'+(clienteSeleccionado===cliente?' selected':'');
                    div.textContent=cliente;
                    div.onclick=()=>{ clienteSeleccionado=cliente; cargarMensajes(cliente); renderClientes(); };
                    const btn=document.createElement('button');
                    btn.textContent = asignaciones[cliente]? 'Asignado a '+asignaciones[cliente] : 'Atender';
                    btn.disabled = asignaciones[cliente]&&asignaciones[cliente]!==agenteNombre;
                    btn.onclick=e=>{ e.stopPropagation(); asignarConversacion(cliente); };
                    div.appendChild(btn);
                    cont.appendChild(div);
                }));
        }
        
        function asignarConversacion(cliente_id) {
            fetch('/conversaciones', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({cliente_id, agente_nombre:agenteNombre})})
                .then(()=>cargarAsignaciones());
        }
        
        function cargarMensajes(cliente_id) {
            fetch(`/mensajes/${cliente_id}`)
                .then(res=>res.json())
                .then(msgs=>{
                    const cont=document.getElementById('chat-mensajes');
                    cont.innerHTML='';
                    msgs.forEach(m=>{
                        const p=document.createElement('div');
                        p.className='msg '+(m.usuario===agenteNombre?'msg-agente':'msg-cliente');
                        p.textContent=`[${m.fecha}] ${m.usuario}: ${m.texto}`;
                        cont.appendChild(p);
                    });
                    cont.scrollTop=cont.scrollHeight;
                });
        }
        
        function responder() {
            const texto=document.getElementById('respuesta').value.trim();
            if(!texto||!clienteSeleccionado) return;
            fetch('/mensajes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cliente_id:clienteSeleccionado,usuario:agenteNombre,texto})})
                .then(()=>{ document.getElementById('respuesta').value=''; cargarMensajes(clienteSeleccionado); });
        }
        
        function cargarTickets() {
            fetch('/tickets')
                .then(res=>res.json())
                .then(data=>{
                    const out=document.getElementById('lista-tickets'); out.innerHTML='';
                    data.forEach(t=>{
                        const d=document.createElement('div'); d.className='ticket';
                        d.innerHTML=`<strong>${t.nombre}</strong> (${t.fecha})<br>${t.email} | ${t.telefono}<br>${t.mensaje}`;
                        const btn=document.createElement('button');
                        btn.textContent=t.atendido?'Atendido':'Marcar atendido';
                        if(t.atendido) btn.disabled=true;
                        else btn.onclick()=>atenderTicket(t.id);
                        d.appendChild(btn);
                        out.appendChild(d);
                    });
                });
        }
        
        function atenderTicket(id){ fetch(`/tickets/${id}`,{method:'POST'}).then(()=>cargarTickets()); }
        
        // Inicializar
        cargarAsignaciones();
        setInterval(cargarAsignaciones, 5000);
    </script>
</body>
</html>
