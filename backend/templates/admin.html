<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Soporte</title>
    <style>
        body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
        #clientes { width: 200px; background: #eee; padding: 10px; overflow-y: auto; }
        #chat { flex: 1; display: flex; flex-direction: column; }
        #chat-mensajes { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; }
        #chat-input { display: flex; padding: 10px; border-top: 1px solid #ccc; }
        #chat-input input { flex: 1; padding: 5px; }
        #chat-input button { padding: 5px 10px; }
        .cliente { cursor: pointer; padding: 5px; border-bottom: 1px solid #ccc; }
        .cliente:hover { background: #ddd; }
    </style>
</head>
<body>
    <div id="clientes"></div>

    <div id="chat">
        <div id="chat-mensajes"></div>
        <div id="chat-input">
            <input type="text" id="respuesta" placeholder="Escribe una respuesta...">
            <button onclick="responder()">Enviar</button>
        </div>
    </div>

    <script>
        let clienteSeleccionado = null;

        function cargarClientes() {
            fetch('/clientes')
                .then(res => res.json())
                .then(data => {
                    const cont = document.getElementById('clientes');
                    cont.innerHTML = '';
                    data.forEach(cliente => {
                        const div = document.createElement('div');
                        div.textContent = cliente;
                        div.className = 'cliente';
                        div.onclick = () => {
                            clienteSeleccionado = cliente;
                            cargarMensajes(cliente);
                        };
                        cont.appendChild(div);
                    });
                });
        }

        function cargarMensajes(cliente_id) {
            fetch(`/mensajes/${cliente_id}`)
                .then(res => res.json())
                .then(data => {
                    const cont = document.getElementById('chat-mensajes');
                    cont.innerHTML = '';
                    data.forEach(msg => {
                        const p = document.createElement('p');
                        p.textContent = `[${msg.fecha}] ${msg.usuario}: ${msg.texto}`;
                        cont.appendChild(p);
                    });
                });
        }

        function responder() {
            const texto = document.getElementById('respuesta').value;
            if (!texto || !clienteSeleccionado) return;

            fetch('/mensajes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cliente_id: clienteSeleccionado,
                    usuario: "Soporte",
                    texto: texto
                })
            }).then(() => {
                document.getElementById('respuesta').value = '';
                cargarMensajes(clienteSeleccionado);
            });
        }

        cargarClientes();
        setInterval(() => {
            if (clienteSeleccionado) cargarMensajes(clienteSeleccionado);
        }, 3000);
    </script>
</body>
</html>
