<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chat de Soporte</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        #chat-container { position: fixed; bottom: 0; right: 20px; width: 300px; background: white; border: 1px solid #ccc; border-radius: 10px 10px 0 0; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #chat-header { background: #ffa500; padding: 10px; color: white; border-radius: 10px 10px 0 0; }
        #chat-messages { max-height: 200px; overflow-y: auto; padding: 10px; }
        #chat-input { display: flex; border-top: 1px solid #ccc; }
        #chat-input input { flex: 1; padding: 10px; border: none; border-radius: 0 0 0 10px; }
        #chat-input button { background: #ffa500; color: white; border: none; padding: 10px; border-radius: 0 0 10px 0; cursor: pointer; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-header">🧺 Chat Comenaranjas</div>
        <div id="chat-messages"></div>
        <div id="chat-input">
            <input type="text" id="message-input" placeholder="Escribe tu mensaje..." />
            <button onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <!-- Cargar el JS de chat con Flask -->
    <script>
        // 🔐 Generar cliente_id único si no existe
        if (!localStorage.getItem('cliente_id')) {
            localStorage.setItem('cliente_id', 'cliente_' + Math.random().toString(36).substring(2, 10));
        }

        const cliente_id = localStorage.getItem('cliente_id');

        function loadMessages() {
            fetch(`/mensajes/${cliente_id}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('chat-messages');
                    container.innerHTML = '';
                    data.forEach(msg => {
                        const div = document.createElement('div');
                        div.textContent = `${msg.usuario}: ${msg.texto}`;
                        container.appendChild(div);
                    });
                    container.scrollTop = container.scrollHeight;
                })
                .catch(err => console.error('Error al cargar mensajes:', err));
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const texto = input.value.trim();
            if (!texto) return;

            fetch('/mensajes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cliente_id,
                    usuario: 'Cliente',
                    texto
                })
            })
            .then(response => response.json())
            .then(() => {
                input.value = '';
                loadMessages();
            })
            .catch(err => console.error('Error al enviar mensaje:', err));
        }

        loadMessages();
        setInterval(loadMessages, 3000);
    </script>
</body>
</html>
